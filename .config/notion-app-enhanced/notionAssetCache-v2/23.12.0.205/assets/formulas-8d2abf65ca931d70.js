"use strict";(self.webpackChunknotion_next=self.webpackChunknotion_next||[]).push([[9447],{64731:(e,n,t)=>{t.r(n),t.d(n,{addTypesToFormulaASTAsync:()=>G,analyzeFormula:()=>W,convertCollectionFormulaToFormula2:()=>T,convertFormulaCSTToAST:()=>r.K,createFormulaDataRequestHandler:()=>F.yf,createFormulaDataRequestSyncHandler:()=>F.lc,evaluateFormulaASTAsync:()=>i.kg,executeFormulaAsync:()=>V,executeFormulaSync:()=>D,formulaResultAndOldFormulaValueEqual:()=>F.hV,getFormula2Dependencies:()=>Y,getFormulaEditorInfoAtPosition:()=>U,getMessageForFormulaEvaluatorError:()=>x.OY,getMessageForFormulaTypecheckError:()=>x.ic,getNodeOfInterestForFormulaTypecheckError:()=>x.sB,isUniqueFormulaEvaluatorError:()=>F.hp,parseFormulaInput:()=>I.K,processFormulaInput:()=>s.dJ});var o=t(68626),r=t(42253),i=t(33063),s=t(51849),a=(t(57658),t(29477)),p=t(606),l=t(21202),u=t(97880),d=t(23790),c=t(84116),y=(t(21703),t(76725)),v=t(70203),f=t(91905),m=t(32620);const h={slice:"substring",start:"dateStart",end:"dateEnd"},b={unaryMinus:"-",unaryPlus:"+",larger:">",largerEq:">=",smaller:"<",smallerEq:"<="},g=["add","subtract","multiply","divide","pow","mod","equal","unequal","larger","largerEq","smaller","smallerEq"];function k(e,n,t){return o=e,r=T(e,n,t),"conditional"===o.type||"function"===o.type&&(g.includes(o.name)||["unaryPlus","unaryMinus"].includes(o.name))||"operator"===o.type&&void 0!==o.args&&o.args.length>=2?[["("],...r,[")"]]:r;var o,r}function T(e,n,t){switch(e.type){case"conditional":return[["if("],...k(e.condition,n,t),[", "],...k(e.true,n,t),[", "],...k(e.false,n,t),[")"]];case"constant":switch(e.value_type){case"number":return(0,v.TPx)(`${e.value}`);case"string":const n=e.value.replace(/\n/g,"\\n").replace(/"/g,'\\"').replace(/\t/g,"\\t");return(0,v.TPx)(`"${n}"`);case"boolean":return(0,v.TPx)(""+(e.value?"true":"false"));default:throw new Error(`unexpected constant type: ${e.value_type}`)}case"function":if(g.includes(e.name)){const o="equal"===e.name?"==":"concat"===e.name?"+":f.Gn[e.name].operator;return[...k(e.args[0],n,t),[` ${o} `],...k(e.args[1],n,t)]}switch(e.name){case"unaryMinus":return[["-"],...k(e.args[0],n,t)];case"unaryPlus":return[["toNumber("],...T(e.args[0],n,t),[")"]];case"month":return[["month("],...T(e.args[0],n,t),[") - 1"]];case"day":return[["day("],...T(e.args[0],n,t),[") % 7"]];case"concat":return[["("],...(0,y.Z)((e.args??[]).map((e=>T(e,n,t))),(()=>[[" + "]])).flat(),[")"]];case"join":return[["join("],["["],...(0,y.Z)((e.args??[]).slice(1).map((e=>T(e,n,t))),(()=>[[", "]])).flat(),["]"],[", "],...T(e.args[0],n,t),[")"]];default:if("id"===e.name)return(0,v.TPx)("id()");const o=h[e.name]??e.name;if(void 0===m.Vr[o])throw new Error(`unexpected formula: ${o}`);return[[`${o}(`],...(0,y.Z)((e.args??[]).map((e=>T(e,n,t))),(()=>[[", "]])).flat(),[")"]]}case"operator":var o,r;if(1===(null===(o=e.args)||void 0===o?void 0:o.length))switch(e.operator){case"not":return[["!"],...k(e.args[0],n,t)];case"+":return[["toNumber("],...T(e.args[0],n,t),[")"]];default:return[[`${e.operator}`],...k(e.args[0],n,t)]}if(2===(null===(r=e.args)||void 0===r?void 0:r.length))return[...k(e.args[0],n,t),[` ${e.operator} `],...k(e.args[1],n,t)];switch(e.operator){case"?":return[...k(e.args[0],n,t),[" ? "],...k(e.args[0],n,t),[" : "],...k(e.args[0],n,t)];default:throw new Error(`unhandled operator: ${e.operator}`)}case"symbol":switch(e.name){case"pi":return(0,v.TPx)("pi()");case"e":return(0,v.TPx)("e()");case"true":return(0,v.TPx)("true");case"false":return(0,v.TPx)("false");default:throw new Error(`unexpected constant: ${e.name}`)}case"property":{const o=t[e.id];if(void 0===o)return[[e.name]];const r=(0,v.YCD)((0,v.kbv)({collection:n,property:e.id,name:o.name}));switch(o.type){case"person":case"relation":return[["join(map("],r,[', format(current)), ", ")']];case"rollup":return o.aggregation&&"show_unique"!==o.aggregation?[r]:[["join(map("],r,[', format(current)), ",")']];case"file":case"multi_select":return[["join("],r,[', ", ")']];case"auto_increment_id":return[r,[".split('-').last().toNumber()"]];default:return[r]}}case"error":throw new Error("unexpected formula error node")}}var x=t(21114),w=t(47218),F=t(78106);function*P(e,n){const{valueTypes:t}=n;switch(e.kind){case w.bG.Number:return{node:{...e,type:{type:"number"},valueTypes:t},errors:[]};case w.bG.String:return{node:{...e,type:{type:"text"},valueTypes:t},errors:[]};case w.bG.Boolean:return{node:{...e,type:{type:"checkbox"},valueTypes:t},errors:[]};case w.bG.NotionToken:{const s=e.token;switch(s.type){case c.Oy.Checkbox:return{node:{...e,type:{type:"checkbox"},valueTypes:t},errors:[]};case c.Oy.BlockProperty:{var o;const i=null===(o=t.find((e=>e.kind===c.yp.ThisRow)))||void 0===o?void 0:o.type;if(void 0===i)return{node:{...e,type:{type:"unknown"},valueTypes:t},errors:[{type:w.h4.ThisRowTypeNotFound,node:e}]};if("block"!==i.type||void 0===i.collection)return{node:{...e,type:{type:"unknown"},valueTypes:t},errors:[{type:w.h4.ThisRowNotBlockWithCollection,node:e}]};if(void 0===s.collection)return{node:{...e,type:c.dy[s.property],valueTypes:t},errors:[]};const a=(yield{recordPointers:[i.collection]}).getRecordModel(i.collection),p=null==a?void 0:a.getNormalizedSchema(),l=(0,F.SR)(s.property),u=null==p?void 0:p[l];var r;if(void 0===u||void 0===p)return{node:{...e,type:{type:"unknown"},valueTypes:t},errors:[{type:w.h4.MissingPropertyOnThisRow,node:e,property:(null===(r=n.formulaPropertyNames)||void 0===r?void 0:r[l])??l}]};const d=yield*(0,F.IP)(l,p,u);return{node:{...e,type:d??{type:"unknown"},valueTypes:t},errors:void 0===d?[{type:w.h4.MemberPropertyTypeInvalid,node:e,token:s,propertyName:u.name,propertyType:u.type}]:[]}}case c.Oy.ContextValue:{var i;const n=null===(i=t.find((e=>e.kind===c.yp.ContextValue&&e.id===(0,F.Kv)(s.valueId))))||void 0===i?void 0:i.type;return void 0===n?{node:{...e,type:{type:"unknown"},valueTypes:t},errors:[{type:w.h4.MissingContextVariable,node:e,token:s}]}:{node:{...e,type:n,valueTypes:t},errors:[]}}case c.Oy.Block:{const n={table:l.iU,id:s.blockId,spaceId:s.spaceId},o=(yield{recordPointers:[n]}).getRecordModel(n);if(void 0===o)return{node:{...e,type:{type:"unknown"},valueTypes:t},errors:[{type:w.h4.MissingBlock,node:e,token:s}]};const r=o.getCollectionPointer();return{node:{...e,type:{type:"block",collection:r},valueTypes:t},errors:[]}}case c.Oy.Person:return{node:{...e,type:{type:"person"},valueTypes:t},errors:[]};case c.Oy.Date:return{node:{...e,type:{type:"date"},valueTypes:t},errors:[]};default:return(0,u.t1)(s)}}case w.bG.Array:{const o=yield*(0,F.LD)(e.elements.map((e=>P(e,n))));let r={type:"unknown"};if(o.length>0){r=o[0].node.type;for(let e=1;e<o.length;e++)if(!(0,d.Jy)(r,o[e].node.type)){r={type:"unknown"};break}}return{node:{...e,elements:o.map((e=>e.node)),type:{type:"array",of:r},valueTypes:t},errors:o.flatMap((e=>e.errors))}}case w.bG.Identifier:{var s;const n=null===(s=t.find((n=>n.kind===c.yp.Binding&&n.id===e.text)))||void 0===s?void 0:s.type;if(void 0!==n)return{node:{...e,type:n,valueTypes:t},errors:[]};const o=m.Vr[e.text];if(void 0===o){const n=[{type:w.h4.UndefinedIdentifier,node:e}];return e.text in h?n.push({type:w.h4.RenamedIdentifier,node:e,identifier:e.text,renamedTo:h[e.text]}):e.text in b&&n.push({type:w.h4.RemovedFunction,node:e,functionName:e.text,alternative:b[e.text]}),{node:{...e,type:{type:"unknown"},valueTypes:t},errors:n}}return{node:{...e,type:{type:"function",libraryFunction:o,calledFromUnifiedFunctionProperty:!1},valueTypes:t},errors:[]}}case w.bG.Conditional:{const o=yield*P(e.condition,n),r=yield*P(e.expIfTrue,n),i=void 0!==e.expIfFalse?yield*P(e.expIfFalse,n):void 0;let s={type:"unknown"};return void 0===r.node.type||void 0!==(null==i?void 0:i.node.type)&&!(0,d.Jy)(r.node.type,i.node.type)||(s=r.node.type),{node:{...e,condition:o.node,expIfTrue:r.node,expIfFalse:null==i?void 0:i.node,type:s,valueTypes:t},errors:[...o.errors,...r.errors??[],...(null==i?void 0:i.errors)??[]]}}case w.bG.LogicalOr:case w.bG.LogicalAnd:const y=yield*(0,F.LD)(e.elements.map((e=>P(e,n)))),v=y.flatMap((e=>e.errors));return{node:{...e,elements:y.map((e=>e.node)),type:{type:"checkbox"},valueTypes:t},errors:v};case w.bG.Equality:case w.bG.Relational:{const o=yield*P(e.lhs,n),r=yield*P(e.rhs,n),i=[...o.errors,...r.errors];if(e.kind===w.bG.Relational){const n=o.node.type,t=r.node.type;"unknown"===n.type||"unknown"===t.type||n.type===t.type&&["number","date","text","checkbox"].includes(n.type)||i.push({type:w.h4.CannotRelativelyCompareTypes,node:e,lhsType:n,rhsType:t})}return{node:{...e,lhs:o.node,rhs:r.node,type:{type:"checkbox"},valueTypes:t},errors:i}}case w.bG.Additive:case w.bG.Multiplicative:case w.bG.Exponentiation:{const o=yield*P(e.lhs,n),r=yield*P(e.rhs,n),i=[...o.errors,...r.errors];if("+"===e.op)return"number"===o.node.type.type&&"number"===r.node.type.type?{node:{...e,lhs:o.node,rhs:r.node,type:{type:"number"},valueTypes:t},errors:i}:{node:{...e,lhs:o.node,rhs:r.node,type:["unknown","number"].includes(o.node.type.type)&&["unknown","number"].includes(r.node.type.type??"unknown")?{type:"unknown"}:{type:"text"},valueTypes:t},errors:i};const s=function(e,n,t){const o=n.type,r=(null==t?void 0:t.type)??{type:"unknown"};if(!["unknown","number"].includes(o.type)||!["unknown","number"].includes(r.type))return{type:w.h4.CannotDoMathOnType,node:e,lhsType:o,rhsType:r}}(e,o.node,r.node);return void 0!==s&&i.push(s),{node:{...e,lhs:o.node,rhs:r.node,type:{type:"number"},valueTypes:t},errors:i}}case w.bG.Unary:{const o=yield*P(e.expression,n),r=[...o.errors];let i;switch(e.op){case"-":["number","unknown"].includes(o.node.type.type)||r.push({type:w.h4.UnaryMinusOnNonNumber,node:e,expression:o.node}),i={type:"number"};break;case"!":case"not":i={type:"checkbox"};break;default:(0,u.t1)(e)}return{node:{...e,expression:o.node,type:i,valueTypes:t},errors:r}}case w.bG.Call:{const{node:o,errors:r}=yield*P(e.expression,n),i=[...r];if(o.kind===w.bG.Identifier&&("lets"===o.text||"let"===o.text)){const r=[];let s=[...t];for(let t=0;t<e.arguments.length-1;t+=2){const o=e.arguments[t],a=e.arguments[t+1];if(o.kind!==w.bG.Identifier){i.push({type:w.h4.IdentifierExpected,node:o});continue}const{node:p,errors:l}=yield*P(a,{...n,valueTypes:s});r[t+1]=p,i.push(...l);const u=o.text;s=[{kind:c.yp.Binding,id:u,name:u,type:p.type},...s],r[t]={...o,type:p.type,valueTypes:s}}const a=e.arguments[e.arguments.length-1];if(!a)return{node:{...e,expression:o,arguments:r,type:{type:"unknown"},valueTypes:s},errors:i};const{node:p,errors:l}=yield*P(a,{...n,valueTypes:s});return r[e.arguments.length-1]=p,i.push(...l),{node:{...e,expression:p,arguments:r,type:p.type,valueTypes:s},errors:i}}["function","unknown"].includes(o.type.type)||i.push({type:w.h4.CallingNotFunction,node:e,callee:o});const s="function"===o.type.type?o.type.libraryFunction:void 0,a="function"===o.type.type?o.type.boundTargetType:void 0;if(void 0!==s){const n=(0,F.P2)(s),t=e.arguments.length+(void 0!==a?1:0);t<n&&("function"===o.type.type&&o.type.calledFromUnifiedFunctionProperty?i.push({type:w.h4.FunctionCallTooFewArguments,node:e,libraryFunction:s,numArguments:t-1,minNumParameters:n-1}):i.push({type:w.h4.FunctionCallTooFewArguments,node:e,libraryFunction:s,numArguments:t,minNumParameters:n}))}const p=[],l=[];void 0!==a&&l.push(a);for(let u=0;u<e.arguments.length;u++){const o=e.arguments[u],r=void 0!==a?u+1:u,y=void 0!==s?(0,F.J3)(s,r):void 0;if(void 0!==s&&void 0===y&&i.push({type:w.h4.FunctionCallUnexpectedArgument,node:e,libraryFunction:s,argument:o,parameterIndex:r}),void 0!==(null==y?void 0:y.augmentScope)){const e=p.map((e=>(null==e?void 0:e.type)??{type:"unknown"})),r=y.augmentScope(void 0!==a?[a,...e]:e),{node:s,errors:d}=yield*P(o,{...n,valueTypes:[...Object.entries(r).map((e=>{let[n,t]=e;return{kind:c.yp.Binding,id:n,type:t}})),...t]});p[u]=s,l.push(s.type),i.push(...d)}else{const{node:t,errors:r}=yield*P(o,n);if(p[u]=t,void 0!==s&&void 0!==y){const n="id"===s.name&&"block"===t.type.type||(0,d.xK)(t.type,y.type);"boolean"==typeof n?(l.push(t.type),n||i.push({type:w.h4.FunctionCallArgumentWrongType,node:e,libraryFunction:s,argument:t,expectedParameter:y})):l.push(n)}else l.push(t.type);i.push(...r)}}return{node:{...e,expression:o,arguments:p,type:void 0!==s?"function"==typeof s.returnType?s.returnType(l):s.returnType:{type:"unknown"},valueTypes:t},errors:i}}case w.bG.UnifiedFunctionProperty:{const o=m.Vr[e.name],{node:r,errors:i}=yield*P(e.expression,n),s=[...i];let a={type:"unknown"};if(void 0===o)s.push({type:w.h4.UnifiedFunctionCannotFindFunction,node:e,name:e.name});else{const n=(0,F.J3)(o,0);if(void 0===n)s.push({type:w.h4.UnifiedFunctionNoArguments,node:e,libraryFunction:o});else{const t="id"===o.name&&"block"===r.type.type||(0,d.xK)(r.type,n.type);"boolean"==typeof t?(a=r.type,t||s.push({type:w.h4.UnifiedFunctionTargetWrongType,node:e,expression:r,libraryFunction:o})):a=t}}return{node:{...e,expression:r,type:void 0!==o?{type:"function",boundTargetType:a,libraryFunction:o,calledFromUnifiedFunctionProperty:!0}:{type:"unknown"},valueTypes:t},errors:s}}case w.bG.MemberBlockProperty:{const{node:o,errors:r}=yield*P(e.expression,n),i=[...r];let s;if("block"===o.type.type)if(void 0===e.propertyToken.collection)s=c.dy[e.propertyToken.property];else{const t=(yield{recordPointers:[e.propertyToken.collection]}).getRecordModel(e.propertyToken.collection),r=null==t?void 0:t.getNormalizedSchema(),l=(0,F.SR)(e.propertyToken.property),u=null==r?void 0:r[l];var a;if(void 0===u||void 0===r)i.push({type:w.h4.MemberPropertyMissing,node:e,property:(null===(a=n.formulaPropertyNames)||void 0===a?void 0:a[l])??l});else if(void 0!==o.type.collection)if((0,p.qo)(e.propertyToken.collection,o.type.collection)){const n=yield*(0,F.IP)(l,r,u);s=n,void 0===n&&i.push({type:w.h4.MemberPropertyTypeInvalid,node:e,token:e.propertyToken,propertyName:u.name,propertyType:u.type})}else i.push({type:w.h4.MemberPropertyMismatchCollection,node:e,token:e.propertyToken})}else"unknown"!==o.type.type&&i.push({type:w.h4.MemberPropertyTargetNotBlock,node:e,expression:o});return{node:{...e,expression:o,type:s??{type:"unknown"},valueTypes:t},errors:i}}case w.bG.RecoveryNode:return{node:{...e,type:{type:"unknown"},valueTypes:t},errors:[]};default:(0,u.t1)(e)}}async function G(e,n,t){const o=P(e,n);let r=o.next();for(;!r.done;){const e=n.handleDataRequest(r.value);r=o.next((0,a.tI)(e)?await e:e)}if(!t)return r.value;const i=r.value.errors.map((e=>{const n=(0,x.sB)(e);return{...e,node:(0,s.tE)(n,t)}}));if(n.sourceProperty){(0,F.JT)(e).includes(n.sourceProperty)&&i.push({type:w.h4.CircularDependency,node:(0,s.tE)(e,t)})}return{node:r.value.node,errors:i}}var I=t(83158),E=t(77090),C=t(58573),N=t(73152);function M(e,n){if(n<e.startOffset||n>e.endOffset+1)return[];const t=e.kind;switch(t){case w.bG.Number:case w.bG.String:case w.bG.Boolean:case w.bG.NotionToken:case w.bG.Identifier:case w.bG.RecoveryNode:return[e];case w.bG.Conditional:{const t=M(e.condition,n);if(t.length>0)return[e,...t];const o=M(e.expIfTrue,n);if(o.length>0)return[e,...o];if(void 0!==e.expIfFalse){const t=M(e.expIfFalse,n);if(t.length>0)return[e,...t]}return[e]}case w.bG.Equality:case w.bG.Relational:case w.bG.Additive:case w.bG.Multiplicative:case w.bG.Exponentiation:{const t=M(e.lhs,n);if(t.length>0)return[e,...t];const o=M(e.rhs,n);return o.length>0?[e,...o]:[e]}case w.bG.LogicalOr:case w.bG.LogicalAnd:case w.bG.Array:for(const t of e.elements){const o=M(t,n);if(o.length>0)return[e,...o]}return[e];case w.bG.Unary:{const t=M(e.expression,n);return t.length>0?[e,...t]:[e]}case w.bG.Call:{const t=M(e.expression,n);if(t.length>0)return[e,...t];for(const o of e.arguments){const t=M(o,n);if(t.length>0)return[e,...t]}return[e]}case w.bG.UnifiedFunctionProperty:case w.bG.MemberBlockProperty:const o=M(e.expression,n);return o.length>0?[e,...o]:[e];default:(0,u.t1)(t)}}const O=["title","text","url","email","phone_number","checkbox","person","created_by","last_edited_by","file","select","multi_select","status","number","date","created_time","last_edited_time","last_visited_time","formula","relation","rollup","auto_increment_id"];async function R(e,n,t){const o=[],r=new Set;if(void 0!==e){const i=n.handleDataRequest({recordPointers:[e]}),s=((0,a.tI)(i)?await i:i).getRecordModel(e),p=null==s?void 0:s.getNormalizedSchema();if(p)for(const[a,l]of Object.entries(p))void 0!==(null==l?void 0:l.type)&&c.WG.includes(null==l?void 0:l.type)&&r.add(l.type),a!==n.sourceProperty&&null!=l&&l.name&&O.includes(null==l?void 0:l.type)&&A(t,l.name)&&o.push({kind:c.WY.Token,name:l.name,token:{type:c.Oy.BlockProperty,property:(0,F.Uw)(a),collection:e}})}for(const i of Object.values(c.vz)){if(r.has(i))continue;const e=(0,F.Ve)(i);(""===t||A(t,e))&&o.push({kind:c.WY.Token,token:{type:c.Oy.BlockProperty,property:i,collection:void 0},name:e})}return o}function A(e,n){return""===e||(0,C.C6)(e,n)}async function B(e){const{prefix:n,context:t,receiverType:o,hideDeprecatedCompletions:r,dotMemberExpression:i}=e,s=[],a=[],p=[],l=new Set;if(void 0===o){var u;t.valueTypes.forEach((e=>{if(e.kind===c.yp.Binding){const t=e.id;!l.has(t)&&n!==e.id&&A(n,e.id)&&(s.push({kind:c.WY.Binding,text:t,type:e.type}),l.add(t))}}));const e=null===(u=t.valueTypes.find((e=>e.kind===c.yp.ThisRow)))||void 0===u?void 0:u.type;"block"===(null==e?void 0:e.type)&&void 0!==e.collection&&a.push(...await R(e.collection,t,n)),t.valueTypes.forEach((e=>{if(e.kind===c.yp.ContextValue&&A(n,e.name)){const n=(0,F.ij)(e.id);a.push({kind:c.WY.Token,token:{type:c.Oy.ContextValue,valueId:n}})}}))}else"block"===o.type&&a.push(...await R(o.collection,t,n));for(const f in m.Vr)if(!l.has(f)&&A(n,f)&&(!r||!f.startsWith("_"))&&("toNumber"!==f||null==o||!o.type||!m.N7.includes(o.type))&&(!i||!m.rq.includes(f))){const e=m.Vr[f];if(void 0!==o){var y,v;const n=(null===(y=e.parameters)||void 0===y||null===(y=y.expected)||void 0===y||null===(y=y[0])||void 0===y?void 0:y.type)??(null===(v=e.parameters)||void 0===v||null===(v=v.varargs)||void 0===v||null===(v=v[0])||void 0===v?void 0:v.type);if(void 0===n||!(0,d.qT)(o,n))continue}p.push({kind:c.WY.LibraryFunction,libraryFunction:e}),l.add(f)}return[...(0,C.ZP)(n,s,(e=>e.text)),...(0,C.ZP)(n,a,(e=>e.name??"")),...(0,C.ZP)(n,[],(e=>e.builtin)),...(0,C.ZP)(n,p,(e=>e.libraryFunction.name))]}function q(e,n){const t=[...e].reverse().find((e=>e.kind===w.bG.Call));if((null==t?void 0:t.kind)===w.bG.Call){let e=-1;if(n>t.lParenOffset&&(void 0===t.rParenOffset||n<=t.rParenOffset))for(e=0;e<t.commaOffsets.length&&!(t.commaOffsets[e]>n);e++);return{expression:t.expression,parameterIndex:e}}}const _={[c.WY.Binding]:0,[c.WY.Token]:1,[c.WY.Builtin]:2,[c.WY.LibraryFunction]:3};async function U(e){var n,t;const{formula:i,inputPosition:a,context:p,hideDeprecatedCompletions:l}=e,[u,d]=(0,s.dJ)(i),y=(0,s.Eh)(d,a);let v=u.substring(0,y);const f=v[v.length-1],h=/[\s.]/.test(f);h&&(v=`${v}_`);const b=(0,N.XR)(),g=(0,N.s)(b).tokenize(v).tokens,k=(0,N.Z8)(b);k.input=g;const T=k.expression(),x=(0,r.K)(T);if(o.x.isFail(x))return{value:void 0};const F=await G(x.value,p,d),{node:P}=F,I=g[g.length-1];let C=!1,O=g;void 0!==I&&(0,E.ol)(I,b.IdentifierName)&&(O=[...O],O.pop(),C=!0);const R=k.computeContentAssist("expression",O),U=C?I.image.substring(0,I.image.length-(h?1:0)):void 0,D=M(P,y),V={inputPosition:a,mappedPosition:y,nodePath:D,callParameter:q(D,y)},W=[],Y=q(D,y),K={handleDataRequest:p.handleDataRequest,valueTypes:P.valueTypes,sourceProperty:p.sourceProperty};let J;for(let o=1;o<=5;o++){const e=M(P,y-o);if(J=e[e.length-1],void 0!==J)break}(null===(n=J)||void 0===n?void 0:n.kind)===w.bG.RecoveryNode&&(J=void 0);const $=void 0!==J&&0===D.length,L=!J||J.kind===w.bG.Unary||J.kind===w.bG.Equality||J.kind===w.bG.Identifier,j=!J||J.kind===w.bG.Equality||J.kind===w.bG.Identifier;for(const o of R){var Z,z,H,X,Q,ee,ne,te,oe;if(o.nextTokenType===b.IdentifierName){const e="dotMemberExpression"===o.ruleStack[o.ruleStack.length-1];if(e){const n=O[O.length-1];if(!(0,E.ol)(n,b.Dot))return{value:void 0};const t=D[D.length-1];if(void 0!==t&&(t.kind===w.bG.UnifiedFunctionProperty||t.kind===w.bG.MemberBlockProperty)){const n=t.expression;V.completionsInfo={type:"member dot receiver",prefix:U,receiverNode:n};const o=await B({prefix:U??"",context:K,receiverType:n.type,hideDeprecatedCompletions:l,dotMemberExpression:e});W.push(...o)}}else{V.completionsInfo={type:"free identifier",prefix:U};const n=await B({prefix:U??"",context:K,hideDeprecatedCompletions:l,dotMemberExpression:e});if(W.push(...n),Y&&(Y.expression.kind===w.bG.UnifiedFunctionProperty&&0===Y.parameterIndex||Y.expression.kind===w.bG.Identifier&&1===Y.parameterIndex)){const e=Y.expression.kind===w.bG.UnifiedFunctionProperty?Y.expression.name:Y.expression.text,n=m.Vr[e];if((null==n?void 0:n.parameters)===m.yx&&A(U??"",m.GV)&&U!==m.GV&&U!==`${m.GV}.`){var re,ie;const e=Y.expression,n="function"===e.type.type&&"array"===(null===(re=e.type.boundTargetType)||void 0===re?void 0:re.type)&&(null===(ie=e.type.boundTargetType)||void 0===ie?void 0:ie.of)||{type:"unknown"};W.push({kind:c.WY.Binding,text:m.GV,type:n}),W.push({kind:c.WY.Binding,text:m.WY,type:{type:"number"}})}}}}else if(o.nextTokenType===b.AdditionOperator&&$&&"text"===(null===(Z=J)||void 0===Z?void 0:Z.type.type)){const e=S(["+"],U??"");W.push(...e)}else if(o.nextTokenType===b.AdditionOperator&&$&&"number"===(null===(z=J)||void 0===z?void 0:z.type.type)){const e=S(["+","-"],U??"");W.push(...e)}else if(o.nextTokenType===b.MultiplicationOperator&&$&&"number"===(null===(H=J)||void 0===H?void 0:H.type.type)){const e=S(["*","/"],U??"");W.push(...e)}else if(o.nextTokenType!==b.RelationalOperator||!$||"number"!==(null===(X=J)||void 0===X?void 0:X.type.type)&&"text"!==(null===(Q=J)||void 0===Q?void 0:Q.type.type)&&"date"!==(null===(ee=J)||void 0===ee?void 0:ee.type.type)){if(o.nextTokenType===b.EqualityOperator&&$&&null!==(ne=J)&&void 0!==ne&&ne.type.type&&"unknown"!==(null===(te=J)||void 0===te?void 0:te.type.type)){const e=S(["==","!="],U??"");W.push(...e)}else if(o.nextTokenType===b.BooleanLiteral&&L){const e=S(["true","false"],U??"");W.push(...e)}else if(o.nextTokenType===b.And&&$&&"checkbox"===(null===(oe=J)||void 0===oe?void 0:oe.type.type)){const e=S(["and","or"],U??"");W.push(...e)}else if(o.nextTokenType===b.UnaryOperator&&j){const e=S(["not"],U??"");W.push(...e)}}else{const e=S([">",">=","<","<="],U??"");W.push(...e)}}const se=null===(t=g[g.length-1])||void 0===t?void 0:t.tokenType;if(0===W.length&&se===b.IdentifierName){const e=g.slice(-4).reverse(),n=[];for(let o=0;o<e.length;o++){var ae;if((null===(ae=e[o])||void 0===ae?void 0:ae.tokenType)!==b.IdentifierName)break;const t=C?e[o].image.substring(0,e[o].image.length-(h?1:0)):void 0;void 0!==t&&(0===o?n.push(t):n.push(t+n[o-1]))}let t=[];for(let o=1;o<n.length;o++){const e=n[o],r=await B({prefix:e.trim(),context:K,hideDeprecatedCompletions:l,dotMemberExpression:!1});if(r.length>0){t=r.map((n=>({...n,overridePrefixLength:e.length+o})))}}W.push(...t)}return V.completions=W.sort(((e,n)=>{const t=e.kind,o=n.kind;return _[t]-_[o]})),{value:V}}function S(e,n){return e.filter((e=>A(n,e))).map((e=>({kind:c.WY.Builtin,builtin:e})))}function D(e,n){const[t,a]=(0,s.dJ)(e),[p,l]=(0,I.K)(t);if(l.length>0)return{error:l[0]};const u=(0,r.K)(p);return o.x.isFail(u)?u:(0,i.u6)(u.value,n)}async function V(e,n){const[t,a]=(0,s.dJ)(e),[p,l]=(0,I.K)(t);if(l.length>0)return{error:l[0]};const u=(0,r.K)(p);return o.x.isFail(u)?u:(0,i.kg)(u.value,n)}async function W(e,n){const[t]=(0,s.dJ)(e),[i,a]=(0,I.K)(t);if(a.length>0)return{value:{parseErrors:a}};const p=(0,r.K)(i);if(o.x.isFail(p))return{value:{parseErrors:[p.error]}};const l=await G(p.value,n),{node:u,errors:d}=l;return{value:{type:u.type,typeErrors:d}}}function Y(e){const[n,t]=(0,s.dJ)(e),[i,a]=(0,I.K)(n);if(a.length>0)return[];const p=(0,r.K)(i);return o.x.isFail(p)?[]:(0,F.JT)(p.value)}}}]);