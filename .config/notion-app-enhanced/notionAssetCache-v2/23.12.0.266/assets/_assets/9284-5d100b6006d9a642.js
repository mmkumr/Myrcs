"use strict";(self.webpackChunknotion_next=self.webpackChunknotion_next||[]).push([[9284],{9284:(e,t,o)=>{o.r(t),o.d(t,{applyFeatures:()=>le,applyPresetFeatures:()=>ne,createTypedDBsInTeam:()=>ve,createWikiInTeam:()=>ge,initializeApp:()=>re,installAppsInTeam:()=>_e,markTasksDatabaseTemplateIfNeeded:()=>oe,removeDependencies:()=>ce});o(57658),o(21703);var r=o(15145),i=o(41432),n=o(90559),a=o(14714),l=o(99036),c=o(80951),p=o(45433),s=o(77657),d=o(6695),u=o(68626),m=o(74181),f=o(72126),v=o(91155),_=o(4615),g=o(21202),S=o(6287),y=o(13493),b=o(9844),w=o(15047),k=o(29369),C=o(19889),h=o(11002),V=o(73314),I=o(70203),P=o(97880),T=o(31412),U=o(34045),M=o(93959),B=o(52821),A=o(78316),R=o(77181),E=o(27383),x=o(33929),z=o(95697),F=o(30874),O=o(26350),D=o(50906),W=o(54642),H=o(81924),N=o(74882),j=o(16956),q=o(58023),Z=o(28673),G=o(47307),K=o(96802),X=o(94419),$=o(86282),Y=o(9953),L=o(75018),J=o(28014),Q=o(150),ee=o(39699);const te=(0,T.defineMessages)({initializeAppTemplateError:{id:"appTemplateActions.initializeAppTemplateError.message",defaultMessage:"Duplicate template failed."}});function oe(e){e&&e.some((e=>e.getFormat().app_config_uri===p.TZ))&&(E.y.locallyMutatedTasksDatabase=!0)}function re(e){const{environment:t,temporaryContainerBlockStore:o,transaction:i}=e,a=ne({...e,initializeStore:o,createOrModify:"create"});return a&&a.length>0&&L.navigateToBlock({environment:t,store:a[0],redirect:!0,pageVisitSource:r.tY.Onboarding}),i.postSubmitCallbacks.push((async e=>{e?G.showErrorMessage(x.default.formatMessage(te.initializeAppTemplateError)):a&&await async function(e){const{environment:t,appCollectionViewBlockStores:o}=e,r=f.oA(o.map((e=>{const t=e.getCollectionViewCollectionStore();if(t){const e=t.getSchema();if((0,n.$z)(e).length>0)return t}})));for(const i of r)await N.K({environment:t,collectionStore:i})}({environment:t,appCollectionViewBlockStores:a})})),a}function ie(e){const{environment:t,spaceViewStore:o,appUri:r,parentStore:n,spaceId:a,transaction:l,presetUri:c}=e,p=(0,U.appConfigs)().find((e=>e.uri===r));if(!n.isDefined()||!p)return;if(0===p.presets.length)throw new Error(`No presets configuration for specified app: ${r}`);const s=p.presets.find((e=>e.uri===c));if(c&&!s)throw new Error("Couldn't find specified preset");const d=s||p.presets[0],u=(0,M.KC)((0,U.appConfigs)(),d),m=p.presets.filter((e=>!(0,M.Mi)(e.uri)));if(r.startsWith("notion://wiki")||1!==m.length){const e=Y.ae({environment:t,table:g.iU,value:{type:i.Ti.collectionViewPage,parent_id:n.id,parent_table:n.table,space_id:a,format:{app_config_uri:r,collection_view_sub_type:"app_container",page_icon:p.logo,app_template_preset:d.uri,app_template_features:u},properties:{title:(0,I.TPx)(r.startsWith("notion://wiki")?p.name:d.shortName)},alive:!0},inMemoryRecordCache:n.inMemoryRecordCache,transaction:l}),c=O.G.createChildStore(n,e.pointer);return me(t,o,n,c,l,"prepend"),[c]}return le({environment:t,spaceViewStore:o,appParentStore:n,appUri:r,features:u,createOrModify:"create",transaction:l})}function ne(e){const{environment:t,appUri:o,presetUri:r,transaction:i,createOrModify:n,from:a}=e,l=(0,U.appConfigs)().find((e=>e.uri===o)),c=null==l?void 0:l.presets.find((e=>e.uri===r));if(c)return i.postSubmitCallbacks.push((e=>{D.Y4z(t,{preset_uri:ae(r),status:Boolean(e)?"fail":"success",from:a}),e&&u.log({level:"error",from:"appTemplateActions.applyPresetFeatures",type:"transactionFailed",error:(0,v.Ui)(e),data:{miscDataToConvertToString:{appUri:o,presetUri:r,createOrModify:n,from:a}}})})),le({...e,features:(0,M.KC)((0,U.appConfigs)(),c)});u.log({level:"error",from:"appTemplateActions.applyPresetFeatures",type:"presetNotFound",error:{name:`Preset not found for appUri ${o} and presetUri ${r}. From: ${a}`}})}function ae(e){return(0,p.SA)(e)?e:"other"}function le(e){const{environment:t,spaceViewStore:o,appParentStore:r,appUri:n,features:s,transaction:u,createOrModify:v}=e,k=(0,U.appConfigs)().find((e=>e.uri===n));if(!k||!r.isDefined())return;let h;if("modify"===v){const t=f.jj(f.oA(e.appCollectionViewBlockStores.map((e=>e.getFormat().app_id))));if(1!==t.length)throw new Error("App collection view block stores must have the same app id");h=t[0]}const V=(0,M._3)({featurePointers:s,appConfig:k});if(0===V.length)return;let T={};if("create"===e.createOrModify&&e.initializeStore){const t=V.filter((e=>"collection_view_block"===e.type));t.length>0&&(Y.sW({store:e.initializeStore,data:{type:e.initializeStore.isType(i.Ti.collectionViewPage)||e.initializeStore.isType(i.Ti.collectionView)?e.initializeStore.getType():i.Ti.collectionViewPage,format:{collection_pointer:e.initializeStore.getFormat().collection_pointer,app_config_uri:t[0].uri,page_icon:t[0].icon,page_cover:t[0].cover},properties:{...e.initializeStore.getProperties(),title:(0,I.TPx)(t[0].name)}},transaction:u}),T[t[0].uri]=e.initializeStore.id)}else"modify"===e.createOrModify&&(T=Object.assign({},...f.oA(e.appCollectionViewBlockStores.map((e=>{var t;return null===(t=e.getFormat())||void 0===t?void 0:t.app_uri_map})))));const B={...T};!function(e,t,o,r,i,n,s){const u=[...r.filter((e=>{let{type:t}=e;return"collection_view_block"===t})),...r.filter((e=>{let{type:t}=e;return"collection"===t})),...r.filter((e=>{let{type:t}=e;return"sub_external_collection"===t})),...r.filter((e=>{let{type:t}=e;return"property"===t})),...r.filter((e=>{let{type:t}=e;return"database_template"===t})),...r.filter((e=>{let{type:t}=e;return"block"===t})),...r.filter((e=>{let{type:t}=e;return"collection_view"===t}))],v=o.table===w.bx?o.id:o.getSpaceId();if(!v)return;for(const c of u)if("collection_view_block"===c.type){const r=i[c.uri];if(r){var _;const i=O.G.createChildStore(o,{table:g.iU,id:r,spaceId:v});null!==(_=pe(t,o,i))&&void 0!==_&&null!==(_=_.getValue())&&void 0!==_&&_.includes(i.id)||me(e,t,o,i,s,"append"),Y.sW({store:i,data:{parent_id:o.id,parent_table:o.table,alive:!0},transaction:s})}else{const r=Y.ae({environment:e,table:g.iU,inMemoryRecordCache:o.inMemoryRecordCache,value:{type:o.table===g.iU&&"app_container"===o.getFormat().collection_view_sub_type?"collection_view":"collection_view_page",parent_id:o.id,parent_table:o.table,space_id:v,format:{app_config_uri:c.uri,page_icon:c.icon,page_cover:c.cover},properties:{title:(0,I.TPx)(c.name)},alive:!0},transaction:s});i[c.uri]=r.id;me(e,t,o,O.G.createChildStore(o,r.pointer),s,"append")}}else if("collection"===c.type){const t=fe(o,c.blockUri,i);if(!t)throw new Error("SubViewBlockStore not found");const r=t.getCollectionViewSourceCollectionStore();r&&q.A9({collectionViewBlockStore:t,collectionStore:r,transaction:s});const n=i[c.uri];if(n){const e=O.NW.createChildStore(o,{table:S.v,id:n,spaceId:v});q.zz({collectionViewBlockStore:t,collectionStore:e,transaction:s}),Y.sW({store:e,data:{alive:!0,parent_id:t.id,parent_table:t.table},transaction:s})}else{const o=Y.ae({environment:e,table:S.v,inMemoryRecordCache:t.inMemoryRecordCache,value:{...c.value,parent_id:t.id,parent_table:t.table,space_id:t.getSpaceId(),format:{app_config_uri:c.uri,app_uri_map:Object.fromEntries(Object.keys(c.value.schema??{}).filter((e=>e.startsWith("notion://"))).map((e=>[e,e]))),...c.value.format},alive:!0},transaction:s});i[c.uri]=o.id;const r=O.NW.createChildStore(t,o.pointer);q.zz({collectionViewBlockStore:t,collectionStore:r,transaction:s})}}else if("sub_external_collection"===c.type){const t=F.Z.getIntegrationsAsRecordMap().getValue({table:b.K2,id:c.integrationId});if(!t||!(0,m.VM)(t))throw new Error("Invalid integration");const r=ue(o,c.parentCollectionUri,i);if(!r)throw new Error("Unable to find parent collection store");const n=r.getDeletedSchema()[c.relationUri];if(n&&(0,l.NK)(n)&&n.collection_pointer){i[c.uri]=n.collection_pointer.id;continue}const a=Z.c({environment:e,pattern:c.pattern,integration:t,parentCollectionStore:r,transaction:s});i[c.uri]=a.id}else if("property"===c.type)de({environment:e,appConfig:n,appParentStore:o,dependency:c,uriMap:i,transaction:s});else if("collection_view"===c.type){const t="block"===o.table&&o.getFormat().app_config_uri===c.blockUri?o:fe(o,c.blockUri,i);if(!t)throw new Error("View's home block not found");const r=i[c.uri];if(r){const e=O.Xr.createChildStore(o,{table:y.n,id:r,spaceId:v});Y.sW({store:e,data:{alive:!0,parent_id:t.id,parent_table:t.table},transaction:s}),X.R3({parent:t.getCollectionViewsStore(),append:e,transaction:s})}else{var k,h,V,T,U,B,A,E,x,z,D;const r=ue(o,c.collectionUri,i);if(!r)throw new Error("View source collection not found");const n=r.getPropertyMapping(),l=e=>(null==n?void 0:n[e])??e,u=null===(k=c.value.format)||void 0===k?void 0:k.collection_group_by,m=u?{...u,property:l(u.property)}:void 0,_=null===(h=c.value.format)||void 0===h?void 0:h.board_columns_by,g=_?{..._,property:l(_.property)}:void 0,S=null==n?void 0:n[p.Es.SubTaskRelation],b=null==n?void 0:n[p.Es.BlockingRelation],w=c.value.type,C=w?(0,d.oz)(w):void 0,I=C?null===(V=c.value.format)||void 0===V?void 0:V[C]:void 0,F=C?{[C]:null==I?void 0:I.map((e=>{const t=l(e.property);return{...e,property:t}}))}:{};if(S&&!(0,R.Av)(w)&&C){var W;const e=null===(W=F[C])||void 0===W?void 0:W.findIndex((e=>e.property===S)),t=F[C];t&&(!e||e<0?t.push({property:S,visible:!0}):t[e].visible=!0)}const H={...c.value.format,collection_group_by:m,board_columns_by:g,property_filters:null===(T=c.value.format)||void 0===T||null===(T=T.property_filters)||void 0===T?void 0:T.map((e=>{let{id:t,filter:o}=e;const{filter:r}=o;if("relation_contains"===r.operator){const e=(Array.isArray(r.value)?r.value:[r.value]).map((e=>{const t=e.type;if("relative"===t)return e;if("exact"===t){const t=e.value,o=t&&i[t];return o?{...e,value:o}:e}(0,P.t1)(t)}));return{id:t,filter:{property:l(o.property),filter:{operator:r.operator,value:e}}}}return{id:t,filter:{...o,property:l(o.property)}}})),collection_groups:null===(U=c.value.format)||void 0===U||null===(U=U.collection_groups)||void 0===U?void 0:U.map((e=>"relation"===e.value.type&&e.value.value&&!(0,a.t2)(e.value.value)&&i[e.value.value.id]?{...e,value:{type:"relation",value:{id:i[e.value.value.id],table:"block",spaceId:r.getSpaceId()}}}:e)),...F,table_subitem_toggle_column:"title",...S?{collection_view_subitem:{property:S}}:{},...b?{timeline_arrows_by:{property:b}}:{}},N=f.oA(null===(B=c.value.page_sort)||void 0===B?void 0:B.map((e=>i[e]))),j=null===(A=c.value.query2)||void 0===A||null===(A=A.aggregations)||void 0===A?void 0:A.map((e=>e.property?{...e,property:(null==n?void 0:n[e.property])??e.property}:e)),q=null===(E=c.value.query2)||void 0===E||null===(E=E.sort)||void 0===E?void 0:E.map((e=>({...e,property:l(e.property)}))),Z=null===(x=c.value.query2)||void 0===x?void 0:x.timeline_by,G=Z?l(Z):void 0,K=null===(z=c.value.query2)||void 0===z?void 0:z.calendar_by,$=K?l(K):void 0,L=null===(D=c.value.query2)||void 0===D?void 0:D.filter,J=L?(0,M.RN)(L,n):void 0,Q=Y.ae({environment:e,table:y.n,inMemoryRecordCache:o.inMemoryRecordCache,value:{...c.value,parent_id:t.id,parent_table:t.table,space_id:v,format:{...H,app_config_uri:c.uri,collection_pointer:r.pointer},query2:{...c.value.query2,filter:J,aggregations:j,sort:q,timeline_by:G,calendar_by:$},page_sort:N,alive:!0},transaction:s});i[c.uri]=Q.id;const ee=O.Xr.createChildStore(t,Q.pointer);X.R3({parent:t.getCollectionViewsStore(),append:ee,transaction:s})}}else if("database_template"===c.type){const t=ue(o,c.collectionUri,i);if(!t)throw new Error("Collection not found");const r=t.getTemplatePagesStore(),n=i[c.uri];if(n){const e=O.G.createChildStore(t,{table:g.iU,id:n,spaceId:t.getSpaceId()});Y.sW({store:e,data:{alive:!0,parent_id:t.id,parent_table:t.table,is_template:!0},transaction:s}),X.R3({parent:r,append:e,transaction:s}),c.isDefault&&K.FH({stores:[t],update:{collection_default_template:{template_page_id:e.id}},transaction:s})}else{var H;const n=Y.ae({environment:e,table:g.iU,inMemoryRecordCache:o.inMemoryRecordCache,value:{...c.blockValue,parent_id:t.id,parent_table:t.table,space_id:t.getSpaceId(),is_template:!0,alive:!0,format:{...null===(H=c.blockValue)||void 0===H?void 0:H.format,app_config_uri:c.uri,...c.blockValue.format}},transaction:s});i[c.uri]=n.id,X.R3({parent:r,append:n,transaction:s}),c.isDefault&&K.FH({stores:[t],update:{collection_default_template:{template_page_id:n.id}},transaction:s})}}else"block"===c.type?se(e,o,c,i,s):"page_template"===c.type||(0,P.t1)(c);!function(e,t,o,r,i){for(const n of o){const o=fe(t,n.uri,r);if(o){const a=o.getParentStore();if(a&&"collection"===a.table&&n.blockValue.properties){const l={};Object.entries(n.blockValue.properties).forEach((o=>{var i,n;let[p,s]=o;if("relation"===(null===(i=a.getSchema()[p])||void 0===i?void 0:i.type)){const e=(0,c.rq)(s),o=f.oA(e.map((e=>{const o=r[e.id];if(o)return{table:g.iU,id:o,spaceId:t.table===w.bx?t.id:t.getSpaceId()}}))),i=(0,c.ow)(o);l[p]=i}else"person"===(null===(n=a.getSchema()[p])||void 0===n?void 0:n.type)&&e.currentUser.id?l[p]=(0,c.C1)([{table:C.KJ,id:e.currentUser.id}]):l[p]=s})),Y.sW({store:o.getPropertiesStore(),data:l,transaction:i})}}}}(e,o,r.filter((e=>{let{type:t}=e;return"block"===t})),i,s)}(t,o,r,V,B,k,u),V.map((e=>{if("collection_view_block"===e.type){const t=fe(r,e.uri,B);t&&function(e,t,o){const r=e.getCollectionViewStores().map((e=>{const o=e.getFormat().app_config_uri;let r=o?null==t?void 0:t.indexOf(o):null==t?void 0:t.length;return void 0!==r&&-1!==r||(r=null==t?void 0:t.length),{viewStore:e,order:r}})),i=f.MR(r,(e=>e.order)).map((e=>e.viewStore.id));Y.sW({store:e,data:{view_ids:i},transaction:o})}(t,e.defaultViewsOrder||[],u)}}));const A=f.oA(f.jj(f.oA(V.map((e=>{if("collection_view_block"===e.type)return e.uri;if("blockUri"in e){const t=(0,M.TD)([e.blockUri],k);if(t&&t.length&&"collection_view_block"===t[0].type)return e.blockUri}}))))),E=f.oA(A.map((e=>fe(r,e,B))));if("create"===v&&e.initializeStore){const t=e.initializeStore.getPermissionItemsStore().getValue();t&&E.forEach((e=>{Y.sW({store:e,data:{permissions:t},transaction:u})}))}const x="create"===v?f.oA([e.initializeStore]):e.appCollectionViewBlockStores,z=E.filter((e=>void 0===x.find((t=>t.id===e.id))));if(x.length>0&&z.length>0){const e=x[x.length-1],t=pe(o,r,e);t&&z.forEach(((o,r)=>{X.HP({parent:t,current:o,after:0===r?e:z[r-1],transaction:u})}))}const D=h||(0,_.ZP)();return function(e,t,o,r,i){e.forEach((e=>{const n=e.getFormat().app_config_uri;if(n){var a;const l=(0,M.$Q)(new Set([n]),t),c={};l.forEach((e=>{o[e.uri]&&(c[e.uri]=o[e.uri])})),c[n]=o[n],K.FH({stores:[e],update:{app_uri_map:{...(null===(a=e.getFormat())||void 0===a?void 0:a.app_uri_map)||{},...c},app_id:r},transaction:i})}}))}(E,V,B,D,u),E}function ce(e){const{environment:t,dependencies:o,appCollectionViewBlockStores:r,from:i}=e,n=function(e){return e.filter((t=>{if("collection"===t.type){return Boolean(e.find((e=>"collection_view_block"===e.type&&e.uri===t.blockUri)))}if("property"===t.type||"collection_view"===t.type||"collection_view_block"===t.type||"page_template"===t.type||"block"===t.type||"database_template"===t.type||"sub_external_collection"===t.type)return!0;(0,P.t1)(t)}))}(o),a=Object.assign({},...f.oA(r.map((e=>{var t;return null===(t=e.getFormat())||void 0===t?void 0:t.app_uri_map}))));ee.createAndCommit({userAction:"appTemplateActions.removeDependencies",environment:t,perform:e=>{!function(e){const{environment:t,appCollectionViewBlockStores:o,dependenciesToRemove:r,completeUriMap:i,transaction:n}=e,a=[...r.filter((e=>{let{type:t}=e;return"collection_view"===t})),...r.filter((e=>{let{type:t}=e;return"block"===t})),...r.filter((e=>{let{type:t}=e;return"database_template"===t})),...r.filter((e=>{let{type:t}=e;return"page_template"===t})),...r.filter((e=>{let{type:t}=e;return"property"===t})),...r.filter((e=>{let{type:t}=e;return"sub_external_collection"===t})),...r.filter((e=>{let{type:t}=e;return"collection"===t})),...r.filter((e=>{let{type:t}=e;return"collection_view_block"===t}))];for(const c of a)if("collection_view_block"===c.type){const e=o.find((e=>{var t;return(null===(t=e.getFormat())||void 0===t?void 0:t.app_config_uri)===c.uri}));e&&n.postSubmitCallbacks.push((o=>{o||W.deleteBlocks(t,{blocks:[{id:e.id,spaceId:e.getSpaceId()}],permanentlyDelete:!0})}))}else if("collection"===c.type){const e=o.find((e=>{var t;return(null===(t=e.getFormat())||void 0===t?void 0:t.app_config_uri)===c.blockUri}));if(e){const t=ue(e,c.uri,i);t&&q.A9({collectionViewBlockStore:e,collectionStore:t,transaction:n})}}else if("property"===c.type){const r=o.find((e=>{var t;return(null===(t=e.getCollectionStore())||void 0===t||null===(t=t.getFormat())||void 0===t?void 0:t.app_config_uri)===c.collectionUri}))??o[0],a=ue(r,c.collectionUri,i);if(a){let o;var l;if("relation"===c.propertySchema.type&&c.propertySchema.collection_pointer)o=ue(r,null===(l=c.propertySchema.collection_pointer)||void 0===l?void 0:l.id,i);j.E2({environment:t,collectionStore:a,schema:a.getSchema(),property:c.uri,transaction:n,targetCollectionStore:o}),D.y9e(t,{property_type:c.propertySchema.type,from:e.from,property:c.uri,collection_id:a.id})}}else if("collection_view"===c.type){const e=i[c.uri];if(!e)throw new Error("Cannot delete view: id not found in map.");const t=o.find((e=>{var t;return(null===(t=e.getFormat())||void 0===t?void 0:t.app_config_uri)===c.blockUri}));if(t){const o=O.Xr.createChildStore(t,{table:y.n,id:e,spaceId:t.getSpaceId()});q.dp({collectionViewBlockStore:t,collectionViewStore:o,transaction:n})}}else"page_template"===c.type||"block"===c.type||"database_template"===c.type||"sub_external_collection"===c.type||(0,P.t1)(c)}({environment:t,appCollectionViewBlockStores:r,dependenciesToRemove:n,completeUriMap:a,transaction:e,from:i})}})}function pe(e,t,o){if(t.table===k.e0)return t.getTeamPagesStore();if(t.table===w.bx){var r,i;if(null!==(r=e.getPrivatePagesStore().getValue())&&void 0!==r&&r.includes(o.id))return e.getPrivatePagesStore();if(null!==(i=e.getSharedPagesStore().getValue())&&void 0!==i&&i.includes(o.id))return e.getSharedPagesStore()}else{if(t.table===g.iU)return t.getContentStore();(0,P.t1)(t)}}function se(e,t,o,r,i){let n=fe(t,o.uri,r);const a="collection"===o.parentType?ue(t,o.parentUri,r):fe(t,o.parentUri,r);if(!a)return{blockStore:n,parentStore:void 0};if(n)Y.sW({store:n,data:{parent_id:a.id,parent_table:a.table,alive:!0},transaction:i});else{const l=t.table===w.bx?t.id:t.getSpaceId();if(!l)return;const c=Y.ae({environment:e,table:g.iU,value:{type:o.blockValue.type,parent_id:a.id,parent_table:a.table,space_id:l,alive:!0,format:{...o.blockValue.format,app_config_uri:o.uri},properties:o.blockValue.properties},inMemoryRecordCache:t.inMemoryRecordCache,transaction:i});n=O.G.createChildStore(a,c.pointer),r[o.uri]=c.pointer.id}return"block"===a.table&&X.R3({parent:a.getContentStore(),append:n,transaction:i}),{blockStore:n,parentStore:a}}function de(e){var t;const{environment:o,transaction:r,appParentStore:i,dependency:n,uriMap:a,appConfig:c}=e,p=ue(i,n.collectionUri,a);if(!p)throw new Error("Collection not found");let d=n.propertySchema;if("relation"===d.type){if(!d.collection_pointer)throw new Error("Invalid relation schema.");const e=ue(i,d.collection_pointer.id,a);if(!e)throw new Error("Relation target collection not found");const t=p.getDeletedSchema(),c=t[n.uri];if(n.isConnectedRelation&&n.integrationId===s.U9&&c&&(0,l.NK)(c)&&c.collection_pointer){const e=A.D8({deletedSchema:t,property:n.uri});if(!e)throw new Error("Deleted property schema was not found");q.xO({environment:o,collectionStore:p,update:e.updateSchema,transaction:r}),q.$N({collectionStore:p,update:e.updateDeletedSchema,transaction:r}),d={...d,collection_pointer:c.collection_pointer,collection_id:c.collection_pointer.id}}else d={...d,collection_pointer:null==e?void 0:e.pointer,collection_id:null==e?void 0:e.pointer.id}}else if("select"===d.type){const e=p.getSchema()[n.uri];if(e&&"select"===e.type){var u;const t=(0,M.TD)([n.uri],c),o=f.xH(f.oA(t.map((e=>{var t;if("property"===e.type&&"select"===e.propertySchema.type)return null===(t=e.propertySchema.options)||void 0===t?void 0:t.map((e=>e.id))})))),r=(null===(u=e.options)||void 0===u?void 0:u.filter((e=>!o.includes(e.id))))||[];d={...d,options:[...d.options||[],...r]}}}else if("auto_increment_id"===d.type){const e=p.getSchema(),t=(0,P.qP)(e).find((e=>{var t;const o=e[0],r=null===(t=e[1])||void 0===t?void 0:t.type;return o&&r&&"auto_increment_id"===r}));if(t){var m;const e=t[0];return K.FH({stores:[p],update:{app_uri_map:{...null===(m=p.getFormat())||void 0===m?void 0:m.app_uri_map,[n.uri]:e}},transaction:r}),n.uri}}else"text"===d.type&&d.ai_inference&&d.ai_inference.auto_update_on_edit&&(d.ai_inference.auto_update_on_edit=(0,B.k4)());q.xO({environment:o,collectionStore:p,update:{[n.uri]:d},transaction:r}),K.FH({stores:[p],update:{app_uri_map:{...null===(t=p.getFormat())||void 0===t?void 0:t.app_uri_map,[n.uri]:n.uri}},transaction:r})}function ue(e,t,o){return o[t]?O.NW.createChildStore(e,{table:S.v,id:o[t],spaceId:e.table===w.bx?e.id:e.getSpaceId()}):void 0}function me(e,t,o,r,i,n){if(o.table!==g.iU)if(o.table===w.bx){if((null==t?void 0:t.getSpaceId())!==o.id)return;J.Hj({environment:e,spaceStore:o,spaceViewStore:t,pageStore:r,isPrivate:!0,transaction:i})}else o.table===k.e0?Q.c0({teamStore:o,store:r,transaction:i,location:{type:n}}):(0,P.t1)(o)}function fe(e,t,o){return o[t]?O.G.createChildStore(e,{table:g.iU,id:o[t],spaceId:e.table===w.bx?e.id:e.getSpaceId()}):void 0}function ve(e){const{presetUri:t,environment:o,spaceViewStore:r,teamStore:i,from:n}=e,a=Date.now(),{serverCommitResult:l,performResult:c}=ee.createAndCommit({userAction:`teamActions.createTypedDBsInTeam.${U.presetUriToHumanReadableName[t]}`,environment:o,perform:e=>{const a=(0,M.iX)((0,U.appConfigs)(),t);if(!a)return;const l=ne({environment:o,spaceViewStore:r,appParentStore:i,appUri:a.uri,createOrModify:"create",transaction:e,presetUri:t,from:n});return H.createSprintPage({environment:o,spaceViewStore:r,appParentStore:i,transaction:e,blockStores:l,creationEntryPoint:{type:"preset",presetUri:t}}),l&&D.bRT(o,{created_block_stores:l,preset_uri:t,destination_team_id:i.id,from:n}),l}});return l.then((()=>{D.meY(o,{from:n,preset_uri:t,time:Date.now()-a})})),c??[]}async function _e(e){const{environment:t,presets:o,spaceStore:r,spaceViewStore:i,teamStore:n}=e,{isAndroid:a,ramSizeInGB:l}=t.device;if(a&&(!l||l<2)){const e=o.slice().reverse().map((e=>{const{serverCommitResult:o,performResult:a}=ee.createAndCommit({environment:t,userAction:"AppsSetup.onContinueWithApps",perform:o=>{var a;const l=null===(a=(0,M.iX)((0,U.appConfigs)(),e))||void 0===a?void 0:a.uri;if(!l)return;return ie({environment:t,spaceViewStore:i,appUri:l,parentStore:(0,z.bq)()?n:r,spaceId:r.id,transaction:o,presetUri:e})}});return{serverCommitResult:o,performResult:a}}));await Promise.all(e.map((e=>e.serverCommitResult)));return f.oA(f.xH(f.GY(e.map((e=>e.performResult)))))}{const{serverCommitResult:e,performResult:{collectionViewBlockStores:a}}=ee.createAndCommit({environment:t,userAction:"AppsSetup.onContinueWithApps",perform:e=>{const a=f.xH(f.oA(o.slice().reverse().map((o=>{var a;const l=null===(a=(0,M.iX)((0,U.appConfigs)(),o))||void 0===a?void 0:a.uri;if(!l)return;return ie({environment:t,spaceViewStore:i,appUri:l,parentStore:(0,z.bq)()?n:r,spaceId:r.id,transaction:e,presetUri:o})}))));return a.reverse(),{collectionViewBlockStores:a}}});return await e,a}}async function ge(e){const{environment:t,spaceStore:o,spaceViewStore:r,teamStore:i,appendOrPrepend:n}=e;return await $.rC({environment:t,item:(0,V.G)(h.Y.teamWiki,x.default.getIntl()),isPrivate:!1,spaceStore:o,spaceViewStore:r,useMinimalTemplates:!0,teamStore:i,type:"inTeam",from:"sidebar_team_section",isOnboarding:!1,appendOrPrepend:n})}},81924:(e,t,o)=>{o.r(t),o.d(t,{createSprintPage:()=>y});var r=o(41432),i=o(45433),n=o(21202),a=o(13493),l=o(15047),c=o(29369),p=o(97880),s=o(31412),d=o(33929),u=o(26350),m=o(58023),f=o(94419),v=o(9953),_=o(28014),g=o(150);const S=(0,s.defineMessages)({sprintBoard_0:{id:"appTemplatesSprintBoardActions.sprintBoard_0",defaultMessage:"Sprint board"}});function y(e){const{environment:t,spaceViewStore:o,appParentStore:s,transaction:y,blockStores:b,creationEntryPoint:w}=e;if("preset"===w.type&&w.presetUri!==i.tt)return;if(!b)return;const k=b.find((e=>e.getFormat().app_config_uri===i.TZ)),C=b.find((e=>e.getFormat().app_config_uri===i.pz));if(!k||!C)return;return function(e){const{environment:t,spaceViewStore:o,appParentStore:s,transaction:y,tasksBlockStore:b,location:w}=e,k=s.table===l.bx?s.id:s.getSpaceId(),C=s.table===l.bx?s:s.getSpaceStore();if(!k||!C)return;const h=function(e){const{environment:t,appParentStore:o,tasksBlockStore:l,transaction:c,spaceId:p}=e,s=function(e){const{environment:t,appParentStore:o,transaction:i,spaceId:a}=e,l=v.ae({environment:t,table:n.iU,value:{type:r.Ti.collectionViewPage,parent_id:o.id,parent_table:o.table,space_id:a,alive:!0,format:{page_icon:"/icons/run_lightgray.svg",special_page_for_pm_launch:"sprint_board"},properties:{title:[[d.default.formatMessage(S.sprintBoard_0)]]}},inMemoryRecordCache:o.inMemoryRecordCache,transaction:i});return u.G.createChildStore(o,l.pointer)}({environment:t,appParentStore:o,transaction:c,spaceId:p});return[i.g3,i.sV,i.y$].forEach((e=>{!function(e){var t;const{collectionViewBlock:o,tasksBlockStore:r,viewUri:i,spaceId:n,transaction:l}=e,c=r.getCollectionPointer(),p=null===(t=r.getFormat())||void 0===t||null===(t=t.app_uri_map)||void 0===t?void 0:t[i];if(!p)return;const s=u.Xr.createChildStore(o,{table:a.n,id:p,spaceId:n});c&&s&&function(e){const{viewStore:t,transaction:o,tasksCollectionPointer:r,viewBlockStore:i}=e,n=t.getName(),a=t.getPageSort(),l=t.getFormat(),c=t.getKeyStore("query2").getValue(),p=t.clone(),s=t.getType();v.sW({store:p,data:{name:n,type:s,page_sort:a,format:{...l,collection_pointer:r},query2:c,alive:!0,parent_id:i.id,parent_table:i.table},transaction:o}),f.R3({parent:i.getCollectionViewsStore(),append:p,transaction:o})}({viewStore:s,transaction:l,tasksCollectionPointer:c,viewBlockStore:o});m.dp({collectionViewBlockStore:r,collectionViewStore:s,transaction:l})}({collectionViewBlock:s,tasksBlockStore:l,viewUri:e,spaceId:p,transaction:c})})),s}({environment:t,appParentStore:s,tasksBlockStore:b,transaction:y,spaceId:k});return function(e,t,o,r,i,a){if(o.table===n.iU)"prepend"===a.type&&f.Ce({parent:o.getContentStore(),prepend:r,before:a.before,transaction:i});else if(o.table===l.bx){if(t.getSpaceId()!==o.id)return;_.Hj({environment:e,spaceStore:o,spaceViewStore:t,pageStore:r,isPrivate:!0,transaction:i,location:a})}else o.table===c.e0?g.c0({teamStore:o,store:r,transaction:i,location:a}):(0,p.t1)(o)}(t,o,s,h,y,w),h}({environment:t,spaceViewStore:o,appParentStore:s,transaction:y,tasksBlockStore:k,location:{type:"prepend",before:C.id}})}},86282:(e,t,o)=>{o.d(t,{RL:()=>x,xv:()=>E,rC:()=>F,Hp:()=>D,Lf:()=>z,$7:()=>R,GF:()=>W});o(21703);var r=o(15145),i=o(68626),n=o(59730),a=o(15157),l=o(45953),c=o(21202),p=o(23867),s=o(31412),d=(o(95477),o(33929)),u=o(98165),m=o(74948),f=o(80444),v=o(77080),_=o(56638),g=o(50906),S=o(54642),y=o(54532),b=o(89858),w=o(9953),k=o(4408),C=o(75018),h=o(24677),V=o(28014),I=o(42875),P=o(29477),T=o(33954);var U=o(39699),M=o(39865);const B="LastViewedTemplateId",A=(0,s.defineMessages)({clientCopyError:{defaultMessage:"Client copy could not be created.",id:"spaceActions.createGettingStartedPage.copyNotCreated.error"}});function R(e){const{environment:t,item:o,createNewPage:r,isPrivate:i}=e;h.ZH(t),_.Z.setState({open:!0,item:o,createNewPage:r,isPrivate:i,isLoading:!1}),a.Z.set({userId:t.currentUser.id,key:B,value:o.rootId}),g.jWY(t,{template_name:o.name,from:r?"sidebar":"newPage"})}function E(e){_.Z.setState({item:_.Z.state.item,open:!1}),h.ZH(e)}async function x(e){const{item:t,environment:o,spaceStore:i}=e;_.Z.state.open&&_.Z.setState({..._.Z.state,isLoading:!0});const n=e.initializeStore?{...e,initializeStore:e.initializeStore,isPrivate:!1,type:"inExistingStore",useMinimalTemplates:!1}:{...e,type:"inSpace",useMinimalTemplates:!1,isOnboarding:!1};let a=!1;const l=Date.now();let c;try{c=await F(n),a=!0,C.navigateToBlock({environment:o,store:c,pageVisitSource:r.tY.Create}),E(o),o.device.isMobile&&m.close()}finally{var p;const r=Date.now()-l,n=e.initializeStore?u.VP(e.initializeStore):void 0,s=e.initializeStore?!Boolean(n):e.isPrivate;g.enX(o,{template_name:t.name,destination:s?"private":"team",template_block_id:t.rootId,template_duplication_duration_ms:r,team_id:null==n?void 0:n.id,created_page_id:null===(p=c)||void 0===p?void 0:p.id}),g.XyT(o,{from:"inApp",success:a,context:e.from,template_name:t.name,template_block_id:t.rootId,target_space_id:i.id,template_duplication_duration_ms:r})}}async function z(e){const{environment:t,initializeStore:o,item:r,isPrivate:i,useMinimalTemplates:n,spaceStore:a,spaceViewStore:c}=e,p=n?r.rootId:r.previewRootId,s=await S.loadBlockSubtree(t,{block:{id:p,spaceId:r.spaceId},shallow:!1});let u;"success"===s.type&&(u=l.PF.create(s.data.subtreeRecordMap));const m="pageTemplateModalActions.loadAndDuplicatePageTemplate",{performResult:f}=U.createAndCommit({userAction:m,environment:t,perform:e=>{const r=o||V.KE({environment:t,spaceStore:a,spaceViewStore:c,isPrivate:i,loading:!0,transaction:e});k.fL({environment:t,inMemoryRecordCache:r.inMemoryRecordCache,recordMap:u,debugSource:m});const n=y.K8(t,{blockId:p,inMemoryRecordCache:r.inMemoryRecordCache,allowCopyCollections:!0,requireFullSubtree:!1,skipTransclusionContainerChildren:!1,allowCopyExternalObjectInstances:!0});if(!n)throw new Error(d.default.getIntl().formatMessage(A.clientCopyError));return y.E9({environment:t,sourceBlockId:p,targetBlockPointer:r.pointer,sourceBlockSubtree:n,targetInMemoryRecordCache:r.inMemoryRecordCache,transaction:e,deepCopyTransclusionContainers:!0,resolveTemplateVariables:!0,useCrdt:r.useCrdt()}),r}});return f}async function F(e){const{environment:t,item:o,useRecordCache:r,isPrivate:i,useMinimalTemplates:n,spaceStore:a,spaceViewStore:l,isOnboarding:p}=e,{serverCommitResult:s,performResult:{pageStore:d,copyBlock:u}}=U.createAndCommit({userAction:"pageTemplateModalActions.createTemplateInstance",environment:t,perform:p=>{let s;s="inExistingStore"===e.type&&e.initializeStore?e.initializeStore:"inTeam"===e.type&&e.teamStore?b.pq({environment:t,spaceStore:a,spaceViewStore:l,teamStore:e.teamStore,from:e.from,loading:!0,appendOrPrepend:e.appendOrPrepend?e.appendOrPrepend:"append",transaction:p}):V.KE({environment:t,spaceStore:a,spaceViewStore:l,isPrivate:i,loading:!0,transaction:p});const d={id:r&&!n?o.previewRootId:o.rootId,table:c.iU,spaceId:o.spaceId};return W({item:o,spaceViewStore:l,transaction:p}),function(e){const{item:t,transaction:o,spaceViewStore:r}=e;if(r){const e=r.getSidebarHiddenTemplateIds();if(e.indexOf(t.rootId)<0){const i=e.concat([t.rootId]);w.sW({store:r,data:{sidebar_hidden_templates:i},transaction:o})}}}({item:o,spaceViewStore:l,transaction:p}),{pageStore:s,copyBlock:d}}});return await s,await D({environment:t,pageStore:d,copyBlock:u,useRecordCache:r,item:o,isOnboarding:Boolean(p)}),d}const O={block:!0,collection:!0,collection_view:!0,discussion:!0,comment:!0};async function D(e){const{environment:t,pageStore:o,copyBlock:r,item:a,useRecordCache:c,isOnboarding:s}=e,u=l.Ak.create();c&&c.forEachRecord(t.currentUser.id,(e=>{let{model:t}=e;O[t.table]&&u.setModel(t.pointer,t)}));const{currentSpaceStore:m}=f.default.state;if(!m)throw new n.p8("Could not get currentSpaceStore.");const _=()=>{U.createAndCommit({userAction:"pageTemplateModalActions.initializePageTemplate.deletePageWhenError",environment:t,perform:e=>{M.y8({environment:t,blocks:[o],transaction:e})}}),s&&g.XyT(t,{success:!1,template_name:a.name,template_id:a.id,template_block_id:a.rootId,target_space_id:m.id,from:"onboarding"}),i.log({level:"error",from:"pageTemplateModalActions.initializePageTemplate",type:"duplicateTemplateError",data:{miscDataToConvertToString:{template_name:a.name,template_id:a.id,template_block_id:a.rootId,is_onboarding:s}}})},y=v.default.getConfigKey("template_ids_to_use_duplicate_block","data");if(null!=y&&y.includes(r.id))await async function(e){const{environment:t,templateBlock:o,targetBlock:r}=e,i=P.UZ(),n=S.duplicateBlock(t,{sourceBlocks:[o],targetBlocks:[r],snapshotData:void 0,addCopyName:!1,deepCopyTransclusionContainers:!0,resolveTemplateVariables:{currentUserId:t.currentUser.id,currentTimeZone:(0,I.r)()},convertExternalObjectInstancesToPlaceholders:o.spaceId!==r.spaceId,useCrdt:!1});let a;for await(const l of n)a=l;if(a)if(a.error){const e=(0,T.HV)(d.default.getIntl(),a.error);i.reject(e)}else i.resolve(a);else i.reject(void 0);return i.promise}({environment:t,templateBlock:r,targetBlock:{id:o.pointer.id,spaceId:(0,p.C)(o.pointer.spaceId)}}).catch(_);else{"failed"===(await S.initializePageTemplate(t,{recordMap:u.toJson({allowVersionDowngrade:!1}),sourceBlock:r,targetBlock:{id:o.pointer.id,table:o.pointer.table,spaceId:(0,p.C)(o.pointer.spaceId)},isOnboarding:s})).type&&_()}return o}function W(e){const{item:t,transaction:o,spaceViewStore:r}=e;if(r){const e=r.getVisitedTemplateIds();if(e.indexOf(t.rootId)<0){const i=e.concat([t.rootId]);w.sW({store:r,data:{visited_templates:i},transaction:o})}}}}}]);